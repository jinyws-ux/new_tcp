# 解析逻辑控制台升级方案

## 目标
- 将现有“字段树 + 右侧表单”升级为具备清晰层次、便于频繁增删改的多列布局。
- 引入分层复制/粘贴、批量操作与就地预览，使多层 JSON 的维护成本接近传统 IDE。
- 保持核心逻辑（`parser-config.js` + `ParserConfigService`）可扩展，避免一次性写死交互。

## 布局与交互改造
1. **三栏结构**：左栏树（可筛选/折叠）、中栏工作面板（字段/版本编辑卡片）、右栏 JSON 预览 & 历史记录。
2. **浮动工具条**：树顶部保留“添加 / 导入 / 导出 / 展开收起 / 搜索”，并新增“复制 / 粘贴 / 取消选择”按钮，方便在任何层级操作。
3. **上下文信息卡**：选中节点后，在中栏顶部展示“厂区 / 系统 / 报文 / 版本 / 字段”面包屑，支持点击跳转。
4. **状态提示区**：右栏底部展示“最近保存时间 / 未保存字段 / 校验错误”，有利于确认当前修改是否已写入磁盘。

## 复制 / 粘贴机制
1. **层级限定的剪贴板**
   - 新增 `clipboard = { level: 'message|version|field|escape', payload: {...} }` 状态。
   - 调用“复制”时写入剪贴板，并在 UI 上提示“已复制 messageType MT01 (含 3 个版本)”。
   - 粘贴按钮根据当前选中层级自动启用/禁用，确保不会将“字段”粘到“报文类型”下。

2. **包含子树**
   - 复制报文类型时，包含其所有版本与字段；复制字段时，包含其转义表。
   - 粘贴时由 `parser-config.js` 内部统一调用 `api.fetchParserConfig` + `ParserConfigService` 的合并方法，保证结构合法。

3. **冲突引导**
   - 当目标层级存在同名节点时，弹出“覆盖 / 保留二者 (自动重命名) / 取消”对话框。
   - 默认建议重命名，例如 `MT01_copy`，引导用户保持层级一致。

4. **操作记录**
   - 每次复制/粘贴/删除都进入历史栈（现有 `historyStack` 可复用），以便用户撤销误操作。

## 额外便捷功能
- **批量搜索/替换**：在树上方增加“字段名 / 版本号 / 转义键”多条件搜索，可在结果列表中批量跳转。
- **字段模板**：支持从常用模板库（本地 JSON）插入一组字段，减少重复录入。
- **即时校验**：字段编辑卡片输入时提示长度/偏移冲突，避免保存后才发现问题。
- **快捷键**：提供 `Ctrl+S` 保存、`Ctrl+C/V` 对应复制粘贴、`Ctrl+Z` 撤销。

## 实施顺序建议
1. **重构 UI 容器**：更新 `web/templates/index.html` 相关区域与 `web/static/css/style.css` 样式，准备新的三栏布局与工具条。
2. **扩展前端状态机**：在 `parser-config.js` 中加入剪贴板、选区面包屑、批量操作等状态，封装 `copyNode`, `pasteNode`, `clearClipboard` 方法。
3. **后端守护**：在 `ParserConfigService` 新增 `clone_subtree` / `merge_subtree` 等纯数据函数，供前端调用，保证粘贴后的 JSON 始终合法。
4. **可视化反馈**：实现状态提示区、校验信息、搜索结果高亮等 UI，提升“工具化”质感。
5. **测试与文档**：补充 `docs/patch_series.md` 新章节，描述如何回滚或独立启用复制/粘贴功能。

通过以上步骤，解析逻辑控制台可以演进为一个层次清晰、操作顺手的多层 JSON 管理器，为后续更多自动化需求打下基础。
